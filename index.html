<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Anime Tracker</title>
  <style>
    :root{
      --bg:#0b0f14;--panel:#121821;--muted:#263041;--text:#e8f0ff;--sub:#9bb0d1;--accent:#6aa8ff;--accent-2:#6affc9;--danger:#ff6a6a;
    }
    body{margin:0;font-family:sans-serif;background:var(--bg);color:var(--text)}
    .container{max-width:1100px;margin:auto;padding:20px}
    header{display:flex;justify-content:space-between;align-items:center}
    table{width:100%;border-collapse:separate;border-spacing:0 10px}
    tbody tr{background:var(--panel)}
    td,th{padding:8px;text-align:left}
    img.cover{width:60px;height:80px;object-fit:cover;border-radius:6px;}
    .links a{margin-right:6px;color:var(--accent);font-size:13px;text-decoration:none}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Anime Tracker</h1>
      <button id="btn-add">+ Add Anime</button>
    </header>
    <table>
      <thead>
        <tr>
          <th>Cover</th>
          <th>Title</th>
          <th>Progress</th>
          <th>Status</th>
          <th>Rating</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </div>

  <dialog id="modal">
    <form method="dialog">
      <h3 id="modal-title">Add Anime</h3>
      <label>Title <input id="m-title" required></label><br>
      <label>Status <select id="m-status"><option>Watching</option><option>Completed</option><option>On Hold</option><option>Dropped</option><option>Plan to Watch</option></select></label><br>
      <label>Episodes Watched <input id="m-watched" type="number" min="0"></label><br>
      <label>Rating (1–10) <input id="m-rating" type="number" min="1" max="10"></label><br>
      <menu>
        <button value="cancel">Cancel</button>
        <button id="modal-save" value="default">Save</button>
      </menu>
    </form>
  </dialog>

<script>
const STORAGE_KEY='anime-tracker.v2';
let data=[];

function uid(){return Math.random().toString(36).slice(2)+Date.now().toString(36)}
function save(){localStorage.setItem(STORAGE_KEY,JSON.stringify(data))}
function load(){try{data=JSON.parse(localStorage.getItem(STORAGE_KEY))||[]}catch{data=[]}render()}

function render(){
  const body=document.querySelector('#rows');
  body.innerHTML='';
  for(const o of data){
    const tr=document.createElement('tr');
    tr.innerHTML=`<td><img class="cover" src="${o.coverUrl||''}"/></td>
    <td><div>${o.title}</div><div class="links">${o.aniUrl?`<a href="${o.aniUrl}" target="_blank">Anilist</a>`:''}${o.malUrl?`<a href="${o.malUrl}" target="_blank">MAL</a>`:''}</div></td>
    <td>${o.watched||0}/${o.total||'?'} eps</td>
    <td>${o.status}</td>
    <td>${o.rating||'–'}</td>`;
    body.appendChild(tr);
  }
}

async function fetchAniList(title){
  const query=`query ($search: String){Media(search:$search,type:ANIME){id siteUrl title{romaji} episodes coverImage{medium} externalLinks{site url}}}`;
  const res=await fetch('https://graphql.anilist.co',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({query,variables:{search:title}})});
  const json=await res.json();
  return json.data?.Media;
}

const modal=document.querySelector('#modal');
const titleInput=document.querySelector('#m-title');
let currentEdit=null;

function openModal(obj){
  document.querySelector('#modal-title').textContent=obj?'Edit Anime':'Add Anime';
  titleInput.value=obj?.title||'';
  document.querySelector('#m-status').value=obj?.status||'Watching';
  document.querySelector('#m-watched').value=obj?.watched||0;
  document.querySelector('#m-rating').value=obj?.rating||'';
  currentEdit=obj;
  modal.showModal();
}

// auto fetch when typing
let timer;
titleInput?.addEventListener('input',()=>{
  clearTimeout(timer);
  timer=setTimeout(async()=>{
    if(!titleInput.value.trim())return;
    const info=await fetchAniList(titleInput.value.trim());
    if(info){
      titleInput.dataset.cover=info.coverImage?.medium||'';
      titleInput.dataset.ani=info.siteUrl;
      const mal=info.externalLinks?.find(x=>x.site==='MyAnimeList');
      titleInput.dataset.mal=mal?mal.url:'';
      titleInput.dataset.total=info.episodes||0;
    }
  },800);
});

modal.addEventListener('close',()=>{
  if(modal.returnValue==='cancel')return;
  const obj={
    id:currentEdit?.id||uid(),
    title:titleInput.value.trim(),
    status:document.querySelector('#m-status').value,
    watched:Number(document.querySelector('#m-watched').value)||0,
    rating:Number(document.querySelector('#m-rating').value)||0,
    coverUrl:titleInput.dataset.cover||currentEdit?.coverUrl||'',
    aniUrl:titleInput.dataset.ani||currentEdit?.aniUrl||'',
    malUrl:titleInput.dataset.mal||currentEdit?.malUrl||'',
    total:Number(titleInput.dataset.total)||currentEdit?.total||0
  };
  if(currentEdit){
    data=data.map(x=>x.id===currentEdit.id?obj:x);
  }else{
    data.push(obj);
  }
  save();render();
});

document.querySelector('#btn-add').addEventListener('click',()=>openModal());

load();
</script>
</body>
</html>


